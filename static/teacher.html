<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Edu+ Aura - Teacher App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f0f2f5;
      color: #2c3e50;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #007bff;
      color: #fff;
      height: 100vh;
      padding-top: 20px;
      position: fixed;
      top: 0; left: 0;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 20px;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      transition: background 0.3s;
    }
    .sidebar a:hover {
      background: #0056b3;
    }

    /* Main content */
    .main {
      margin-left: 220px;
      padding: 20px;
      flex: 1;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .navbar h1 {
      font-size: 22px;
      margin: 0;
      color: #007bff;
    }
    .refresh-btn {
      padding: 8px 15px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .refresh-btn:hover {
      background: #0056b3;
    }

    /* Summary Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: linear-gradient(135deg,#6a11cb,#2575fc);
      border-radius: 12px;
      padding: 20px;
      color: #fff;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card h3 { margin:0; font-size:16px; font-weight:500; }
    .card p { font-size:28px; margin-top:10px; font-weight:bold; }

    /* Student List */
    .student {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: transform 0.2s, background 0.2s;
    }
    .student.present {
      background: #d4ffd4;
    }
    .student:hover { transform: translateY(-2px); }

    .student button {
      padding: 6px 12px;
      background: #007bff;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .student button:hover {
      background: #0056b3;
    }

    .controls {
      margin-bottom: 20px;
    }
    .controls button {
      margin: 4px;
      padding: 8px 12px;
      background: #28a745;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .controls button:hover { background:#218838; }

    #log {
      white-space: pre-wrap;
      background: #f7f7f7;
      padding: 12px;
      border-radius: 8px;
      max-height: 150px;
      overflow:auto;
      margin-top: 10px;
    }

    #reader {
      width:100%;
      max-width:400px;
      margin: 10px 0;
      border-radius:8px;
      overflow:hidden;
    }

    .chart-container {
      width: 100%;
      max-width: 500px;
      margin: 20px 0;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    @media(max-width:768px){
      .sidebar {width:100px;}
      .main {margin-left:100px;}
      .sidebar h2 {font-size:16px;}
      .sidebar a {font-size:14px; padding:10px;}
      .card p {font-size:22px;}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Edu+ Aura</h2>
    <a href="#">ðŸ“Š Dashboard</a>
    <a href="#">âœ… Attendance</a>
    <a href="#">ðŸ“‘ Reports</a>
  </div>

  <div class="main">
    <div class="navbar">
      <h1>Teacher App</h1>
      <button class="refresh-btn" onclick="loadStudents();updateChart();">âŸ³ Refresh</button>
    </div>

    <div class="controls">
      <label>Class: <strong>A</strong></label><br>
      <button onclick="simulateScan()">Simulate Scan</button>
      <button onclick="startQR()">Start QR Scanner</button>
      <button onclick="stopQR()">Stop QR</button>
      <button onclick="sync()">Sync</button>
      <button onclick="clearCache()">Clear Cache</button>
    </div>

    <div class="chart-container">
      <canvas id="attendanceChart"></canvas>
    </div>

    <div id="reader"></div>
    <div id="students"></div>

    <h3>Local Cache (pending records)</h3>
    <div id="log">No pending records.</div>
  </div>

<script>
const API = window.location.origin;
let students = [];
let html5QrCode = null;
let chart;

async function loadStudents(){
  let res = await fetch(API + '/api/students');
  students = await res.json();
  renderStudents();
  updateChart();
}
function renderStudents(){
  let container = document.getElementById('students');
  container.innerHTML = '';
  let presentCount = 0;
  students.forEach(s=>{
    let div = document.createElement('div');
    div.className='student';
    div.id='s_'+s.id;
    div.innerHTML = `<div><strong>${s.roll}. ${s.name}</strong><br><small>Roll:${s.roll} | Class:${s.class}</small></div>
                     <div><button onclick="mark(${s.id})">Mark Present</button></div>`;
    container.appendChild(div);
  });
  refreshLog();
}

function getCache(){ return JSON.parse(localStorage.getItem('edu_cache')||'[]'); }
function saveCache(c){ localStorage.setItem('edu_cache', JSON.stringify(c)); refreshLog(); }
function refreshLog(){
  let c = getCache();
  let log = document.getElementById('log');
  if(c.length==0) log.innerText='No pending records.';
  else log.innerText = c.map(x=>`ID:${x.student_id} @ ${x.date} ${x.time} (${x.method})`).join('\n');
}
function mark(id, method='manual'){
  const d = new Date();
  const record = {student_id:id, date:d.toISOString().slice(0,10), time:d.toTimeString().slice(0,8), method:method};
  let c = getCache(); c.push(record); saveCache(c);
  let el = document.getElementById('s_'+id);
  if(el) el.classList.add('present');
  updateChart();
}
function simulateScan(){
  students.slice(0,3).forEach(s=> mark(s.id, 'simulated-scan'));
  alert('Simulated scan: marked first 3 students present locally.');
}

async function sync(){
  let c = getCache();
  if(c.length==0){ alert('No pending records to sync.'); return; }
  try{
    let res = await fetch(API + '/api/attendance', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({records:c, origin:'teacher-demo'})
    });
    let j = await res.json();
    if(j.status=='ok'){
      alert('Synced '+ j.inserted + ' records to server.');
      localStorage.removeItem('edu_cache');
      refreshLog();
    } else {
      alert('Sync failed');
    }
  } catch(e){
    alert('Sync error (offline or server unreachable).');
  }
}
function clearCache(){ localStorage.removeItem('edu_cache'); refreshLog(); location.reload(); }

// QR scanning
function startQR(){
  if(html5QrCode) return;
  html5QrCode = new Html5Qrcode("reader");
  const config = { fps:10, qrbox:250 };
  html5QrCode.start({ facingMode: "environment" }, config, qrCodeMessage=>{
    let sid = parseInt(qrCodeMessage);
    if(!isNaN(sid)) mark(sid,'qr-scan');
  }).catch(err=>{console.error(err);});
}
function stopQR(){
  if(html5QrCode){
    html5QrCode.stop().then(()=>{
      html5QrCode.clear();
      html5QrCode=null;
    });
  }
}

// Attendance Chart
function updateChart(){
  let total = students.length;
  let present = document.querySelectorAll('.student.present').length;
  let absent = total - present;

  const ctx = document.getElementById('attendanceChart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Present','Absent'],
      datasets:[{
        data:[present,absent],
        backgroundColor:['#28a745','#dc3545'],
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:'bottom'}}
    }
  });
}

loadStudents();
</script>
</body>
</html>
